flow:
  name: "misc-ourworldindata-chart-mattermost"
  params:
    interval: "12h"

  input:
    plugin: "resty"
    params:
      input: ["https://ourworldindata.org/latest"]

  process:
    - id: 0
      plugin: "xpath"
      alias: "extract sub paths to charts"
      params:
        input:  ["resty.body"]
        output: ["data.array0"]
        xpath:  [
          "//article[contains(@class, 'post-card')]/a/@href", 
        ]
        xpath_array: true
        xpath_html: false

    - id: 1
      plugin: "regexpreplace"
      alias: "make full links to charts"
      params:
        input:   ["data.array0"]
        output:  ["data.array1"]
        regexp:  ['/']
        replace: ['https://ourworldindata.org/']

    - id: 2
      plugin: "same"
      alias: "filter already seen links"
      params:
        require: [1]
        input: ["data.array1"]
        same_ratio_max: 0
        same_ratio_min: 0
        same_share_max: 100
        same_share_min: 100
        same_ttl: "365d"

    - id: 3
      plugin: "split"
      params:
        require: [2]
        input:  ["data.array1"]
        output: ["data.text0"]

    - id: 4
      plugin: "webchela"
      alias: "let js to create links to svg"
      params:
        require: [3]
        template: "templates.webchela.default"
        input:  ["data.text0"]
        output: ["data.text1"]
 
    - id: 5
      plugin: "io"
      alias: "read fetched pages to vars"
      params:
        require: [4]
        input:  ["data.text1"]
        output: ["data.text2"]
        file_in: true
        file_in_mode: "text"
 
    - id: 6
      plugin: "regexpfind"
      alias: "extract links to charts"
      params:
        require: [5]
        input:  ["data.text2"]
        output: ["data.array2"]
        regexp: ['(src=)(")(https://assets.ourworldindata.org/grapher/exports/[a-zA-z0-9-]+.svg)(")']
        group: [[3]]

    - id: 7
      plugin: "fetch"
      alias: "fetch charts"
      params:
        require: [6]
        input:  ["data.array2"]
        output: ["data.array3"]
 
    - id: 8
      plugin: "split"
      alias: "avoid mattermost limits for sending more than 10 files"
      params:
        include: true
        require: [7]
        input:  ["data.array3"]
        output: ["data.textA"]

  output:
    plugin: "mattermost"
    params:
      cred: "cred.mattermost.default"
      files: ["data.textA"]
      output: ["news_charts"]
